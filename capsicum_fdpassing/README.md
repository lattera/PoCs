fdpassing
=========

The fdpassing Proof of Concept (PoC) shows how to pass capsicumized
file descriptors between a fully capsicumized parent process and
non-capsicumized child.

This is meant to provide the underlying design and architecture of the
Tor Capsicumization project.

Design
------

The parent process creates a local UNIX socketpair. The parent then
forks and the child daemonizes. The parent will set read and write
limits on its socketpair file descriptor and will enter capabilities
mode.

During Tor's initialization, Tor will ask its sandbox API to whitelist
certain local resources in advance. The parent process (Tor itself)
will advertise to the client to whitelist the requested resource.
Later on in Tor's lifecycle, the parent process will request the
whitelisted resource. The child will check whether the resource is
allowed and will open the file with the requested permissions and
pass the pre-capsicumized file descriptor back to the parent.

In the current design, all network resources will be whitelisted. The
current design does not take into account preventing connections to
unwanted remote services. However, the design of the data structures
can account for whitelisting remote (network) resources at a later
date.

Please note that all file descriptors passed from the child process to
the parent process have capability sets applied by the child. This
ensures that file descriptors cannot be abused by the parent process.

Each file descriptor is labeled with a unique UUID, generated by the
child process. This allows the parent process to tell the child
process to close its copy of the file descriptor. This prevents
resource exhaustion at the cost of generating UUIDs. It is the
parent's responsibility to tell the child to close a resource.
